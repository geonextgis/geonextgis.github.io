name: Sync Overleaf & Build PDF

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. Checkout
      - name: Checkout Git Repo
        uses: actions/checkout@v4

      # 2. Pull from Overleaf
      - name: Sync with Overleaf
        uses: subhamx/overleaf_sync_with_git@master
        with:
          OVERLEAF_PROJECT_ID: ${{ secrets.OVERLEAF_PROJECT_ID }}
          OVERLEAF_COOKIE: ${{ secrets.OVERLEAF_COOKIE }}

      # 3. Commit changes (Backup source code)
      - name: Commit Overleaf Changes
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add .
          git commit -m "Sync from Overleaf" || echo "No changes to commit"
          git push

      # 4. Compile LaTeX
      - name: Compile LaTeX
        uses: xu-cheng/latex-action@v3
        with:
          root_file: main.tex          # ✅ Correct filename
          working_directory: artifacts # ✅ Correct folder path

      # 5. Rename output
      - name: Rename PDF
        # ✅ Uses 'sudo' to fix permission error
        # ✅ Moves 'main.pdf' from 'artifacts/' folder
        run: sudo mv artifacts/main.pdf Krishnagopal_Halder_CV.pdf

      # 6. Upload Release
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest CV
          body: "Automatic sync from Overleaf."
          files: Krishnagopal_Halder_CV.pdf
          make_latest: true
          overwrite: true # ✅ Prevents errors if tag exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}